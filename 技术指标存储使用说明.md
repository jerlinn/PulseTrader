# 技术指标存储系统使用说明

## 概述

技术指标存储系统已优化，现在可以自动计算、存储和持久化以下数据：

- **RSI14 数值**：14日相对强弱指标
- **RSI 背离信号**：顶背离和底背离，包含置信度
- **MA10 数值**：10日移动平均线
- **趋势上轨数值**：SuperTrend 压力
- **趋势下轨数值**：SuperTrend 支撑
- **趋势状态**：上升(1)/下降(-1)/中性(0)
- **趋势信号**：买入/卖出信号点

## 架构优化

✅ **统一存储** - 所有数据现在存储在统一的 SQLite 数据库中
- 原始股票数据：`stock_data` 表
- 技术指标数据：`technical_indicators` 表  
- RSI背离信号：`rsi_divergences` 表
- 趋势变化信号：`trend_signals` 表
- 股票信息：`stock_info` 表

## 文件结构

```
TrendSight/
├── indicators_storage.py      # 技术指标计算和存储
├── indicators_query.py        # 数据查询工具
├── stock_cache.py            # 统一数据库管理 
├── cache/
│   └── stock_data.db         # SQLite数据库(包含所有数据)
└── TrendInsigt.py            # 已集成指标存储
```

## 使用方法

### 1. 运行股票分析（自动存储指标）

```bash
python TrendInsigt.py
```

运行时会自动：
- 计算所有技术指标
- 存储到 `data/` 目录
- 在终端显示指标摘要
- 在分析报告中包含指标数据

### 2. 查询已存储的指标数据

```bash
# 查看指定股票的技术指标
python indicators_query.py 杭钢股份

# 列出所有可用股票
python indicators_query.py --list

# 导出股票数据为CSV
python indicators_query.py 杭钢股份 --export
```

### 3. 数据库管理

数据库管理现在集成在 `stock_cache.py` 中：

```python
from stock_cache import StockDataCache

# 创建缓存管理器
cache = StockDataCache()

# 查看缓存状态（包含技术指标统计）
cache.show_cache_status()

# 优化数据库性能
cache.optimize_database()

# 获取已缓存的股票列表
cached_stocks = cache.get_cached_stocks()
```

## 数据格式

### 技术指标数据结构
```json
{
  "date": "2024-08-14",
  "rsi14": 65.4,
  "ma10": 12.45,
  "trend_upper": 13.2,
  "trend_lower": 11.8,
  "trend_status": 1,
  "supertrend_value": 12.1
}
```

### RSI 背离信号结构
```json
{
  "date": "2024-08-14",
  "prev_date": "2024-08-10",
  "type": "bearish",
  "timeframe": "medium",
  "rsi_change": -5.2,
  "price_change": 3.4,
  "confidence": 78.5,
  "current_rsi": 68.3,
  "prev_rsi": 73.5
}
```

### 趋势信号结构
```json
{
  "date": "2024-08-14",
  "signal_type": "buy",
  "price": 12.45,
  "trend_value": 12.1
}
```

## 新增功能

### 1. 分析报告增强
- 自动在 Markdown 报告中包含技术指标数据
- 显示最新指标值和背离信号
- 包含趋势变化信号历史

### 2. 终端显示优化
- 运行 `TrendInsigt.py` 时显示技术指标摘要
- 彩色显示趋势状态和信号强度
- 实时显示背离信号和置信度

### 3. 数据持久化
- 每次分析自动保存完整指标数据
- 支持历史数据查询和导出
- 提供数据清理和压缩功能

## 技术特性

- **统一存储**：SQLite数据库统一管理原始数据和技术指标
- **消除重复**：移除了data/目录，避免功能重叠
- **高性能**：数据库索引优化，支持快速查询
- **数据完整性**：关系型数据库确保数据一致性
- **向后兼容**：API保持不变，无缝集成

## 使用示例

```python
# 在你的脚本中使用
from indicators_storage import enhance_analysis_with_indicators

# 增强分析并自动存储到数据库
result = enhance_analysis_with_indicators(df, stock_name, symbol)

# 获取指标摘要（从数据库）
storage = IndicatorsStorage()
summary = storage.get_latest_indicators(stock_name)
```

## 迁移说明

✅ **已完成的架构优化**：
- 删除了重复的 `data/` 目录和JSON文件存储
- 所有技术指标数据现在存储在 `cache/stock_data.db` 中
- 提供更高效的数据库查询和管理功能
- 保持了相同的API接口，确保向后兼容性

通过这个优化后的系统，所有数据都在统一的SQLite数据库中，避免了存储重叠，提供了更好的性能和数据管理能力。